<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>StructChat</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
		<link rel="stylesheet" type="text/css" href="/static/semantic.css">
		<script type="text/javascript" src="/static/semantic.js"></script>
		<script type="text/javascript">
			var last_timestamp = "";
			var loading_messages=true;

			window.onload = function() {
				$.get("/api/getlatestpost?timestamp="+encodeURIComponent(last_timestamp), function(data){$( "#message_feed" ).append( data );});
				while (loading_messages) {
					$.ajax({
					  url: "/api/getlatestpost?timestamp="+encodeURIComponent(last_timestamp),
					  dataType: 'html',
					  async: false,
					  error: function (msg) { console.log(msg); },
					  success: function(data) {
					  	console.log(data);
						if (data.length<10) {loading_messages = false};
						$( "#message_feed" ).append( data );
					  }
					});
				}

				$("#scrollArea").animate({
								scrollTop:$("#scrollArea").prop("scrollHeight")
							}, 300);

				setInterval(function()
					{
						if (last_timestamp!="") {
							$.get("/api/getlatestpost?timestamp="+encodeURIComponent(last_timestamp), function(data){
								$( "#message_feed" ).append( data );
							});

						}

						else {
							$.get("/api/getlatestpost", function(data){
								$( "#message_feed" ).append( data );
							});
						}
						$("#scroll_area").animate({
							scrollTop:$("#scroll_area").prop("scrollHeight")
						}, 300);
					},
					1000);
			};

			function sendChatMessage() {
				console.log($('#message_input').value)
				$.get("/post?message_input="+encodeURIComponent($('#message_input').value), function(data){});
				document.getElementById('message_input').value=""
				return false
			}
		</script>
	</head>
	<body>
		<style type="text/css">

			body {
				background-image: url('/static/blueprint_bg.jpg');
			}

			.menu {
				max-width: 95%;
			}

			.segment {
				max-width: 95%;
				opacity: 0.9;
				overflow: auto;
			}

			.scroll_area {
				height: 80%;
				max-height: 80%;
			}
			
		</style>
		{% include "header.html" %}
		<br>
		<div class="ui segment scroll_area" id="scroll_area" style="margin: 0 auto;">
			<div class="ui feed" id="message_feed" name="message_feed"></div>
		</div>
		<br>
		<div class="ui segment" style="margin: 0 auto;">
			<form onsubmit="return sendChatMessage();">
				<!-- {% csrf_token %} -->
				<div class="ui action input" style="width:100%;">
					<input placeholder="type message here" name="message_input" id="message_input" type="text">
					<button onclick="sendChatMessage();" class="ui orange button">Send</button>
				</div>
			</form>
		</div>
	</body>
</html>
